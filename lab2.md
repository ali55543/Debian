Лабораторная работа №2  Исмаилов А.А. ИС-21
## Резервное копирование, восстановление и мониторинг в Debian и PostgreSQL

---

## 1. Утилиты резервного копирования

В PostgreSQL есть два основных способа бэкапа: `pg_dump` и `pg_basebackup`.

- `pg_dump` — это логическая копия. Подходит, когда нужно сохранить одну конкретную базу, схему или даже таблицу. Удобно для миграций, тестов и т.п.
- `pg_basebackup` — это уже физическая копия всего кластера. Используется, например, для настройки репликации или полного восстановления после сбоя.

**Разница между ними:**

| Что сравниваем     | pg_dump                         | pg_basebackup                      |
|--------------------|----------------------------------|------------------------------------|
| Что копирует       | Логика (схемы, таблицы, данные) | Физическая структура кластера      |
| Подходит для       | Частичного восстановления       | Репликации, аварийного восстановления |
| Минусы             | Не захватывает настройки        | Большой размер, нужен downtime (без реплики) |

---

## 2. Полный дамп базы

Создавал полный дамп базы из ЛР №1 вот так:

```bash
pg_dump -U postgres -F c -f full_backup.dump lab1_db
```

Параметры:
- `-F c` — формат custom. Он сжатый и его потом удобно восстанавливать через `pg_restore`.
- Ещё бывают `-F t` (tar) и `-F p` (plain SQL), но custom более гибкий.

---

## 3. Частичный бэкап (по схеме и таблицам)

Чтобы не бэкапить всё подряд, делал дамп только схемы `test_schema`:

```bash
pg_dump -U postgres -n test_schema -F c -f schema_backup.dump lab1_db
```

А потом сделал дамп только нескольких таблиц из `public`:

```bash
pg_dump -U postgres -t public.table1 -t public.table2 -F c -f tables_backup.dump lab1_db
```

Разница в том, что такие дампы легче, восстанавливаются быстрее и не мешают остальной базе.

---

## 4. Восстановление из дампа

### Если дамп в формате custom:

```bash
pg_restore -U postgres -d lab1_db_restored full_backup.dump
```

### Если plain SQL:

```bash
psql -U postgres -d lab1_db_restored -f full_backup.sql
```

В обоих случаях база восстанавливается, таблицы и данные на месте.

---

## 5. Автоматизация с cron

Добавил задание в crontab:

```bash
crontab -e
```

Пример строки:

```cron
0 2 * * * pg_dump -U postgres -F c -f /var/backups/pg/lab1_db_$(date +\%F).dump lab1_db
```

Это делает бэкап каждый день в 2:00 ночи.

Чтобы старые дампы не копились вечно, добавил ротацию:

```bash
find /var/backups/pg/ -type f -mtime +7 -name "*.dump" -exec rm {} \;
```


---

## 6. Мониторинг системы

Смотрел, как PostgreSQL грузит систему с помощью:

- `top` — показывает процессы и загрузку CPU/памяти.
- `htop` — красивее и удобнее.
- `iotop` — отслеживает нагрузку на диск.

**Важно понимать, что значит:**
- `%CPU` — сколько процентов CPU жрёт процесс.
- `%MEM` — сколько оперативки занято.
- IO — полезно, когда база активно пишет/читает.

---

## 7. Мониторинг PostgreSQL

В PostgreSQL есть встроенные представления:

```sql
SELECT * FROM pg_stat_activity;
SELECT * FROM pg_stat_database;
```

С их помощью видно, какие запросы сейчас активны, какие базы как используются и т.д.

Если вдруг процесс завис или слишком долго работает, можно прибить его (если есть права суперпользователя):

```sql
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'active' AND pid <> pg_backend_pid();
```

---

## 8. Логирование

PostgreSQL пишет свои логи в:

```
/var/log/postgresql/postgresql-XX-main.log
```

А системные логи находятся в:

```
/var/log/syslog
/var/log/daemon.log
```

